<!DOCTYPE html>
<html lang="fr">
  <head>
<meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DOMOTIC 3</title>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
   <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
   <script type="text/javascript">
      google.charts.load('current', {'packages':['gauge']});
      google.charts.setOnLoadCallback(drawChart);
	  // ThingSpeak variables
      var channel_id = 2344475;
      var api_key = 'WK1HKJMH6AFPC2F2';
      var max_gauge_value = 50;
      // global variables
      var data;
      var options;
	   
      function drawChart() {

 data = new google.visualization.arrayToDataTable([
                ['Label', 'Value'],
		['Exterieur', 0], // Valeur initiale à 0 ou à un autre nombre par défaut
		['Interieur', 0],
		['Insufl.', 0],
		['Extract.', 0]
        ]);

 options = {
          width: 800, height: 240,
          redFrom: 35, redTo: 50,
          yellowFrom: 25, yellowTo: 35,
          minorTicks: 5,
          max: 50,
          min: -10
        };
var chart = new google.visualization.Gauge(document.getElementById('chart_div'));
        loadData();
        chart.draw(data, options);
		
        // Load new data every 15 seconds
        setInterval(loadData, 15000);
      }
    // Load the data from ThingSpeak
      function loadData() {
      $.getJSON('https://api.thingspeak.com/channels/' + channel_id + '/feed/last.json?api_key=' + api_key, function(responseData) {
	      console.log('Données renvoyées par l\'API Thingspeak :', responseData);
          var p1 = responseData.field1;
          var p2 = responseData.field2;
          var p3 = responseData.field3;
          var p4 = responseData.field4;
	      console.log('Valeurs récupérées : p1 =', p1, ', p2 =', p2, ', p3 =', p3, ', p4 =', p4);

          if (p1) {
             p1 = parseFloat(p1).toFixed(2); // Assurez-vous que p1 est bien un nombre et formatez-le avec deux décimales
    displayData('Exterieur', p1, options);
}
if (p2 != null) {
    p2 = parseFloat(p2).toFixed(2); // Assurez-vous que p2 est bien un nombre et formatez-le avec deux décimales
    displayData('Interieur', p2, options);
}
if (p3 != null) {
    p3 = parseFloat(p3).toFixed(2); // Assurez-vous que p3 est bien un nombre et formatez-le avec deux décimales
    displayData('Insufl.', p3, options);
}
if (p4 != null) {
    p4 = parseFloat(p4).toFixed(2); // Assurez-vous que p4 est bien un nombre et formatez-le avec deux décimales
    displayData('Extract.', p4, options);
          }
        });
      }
	function displayData(label, point, options) {
    // Find the row index based on the label
    var rowIndex;
    switch(label) {
        case 'Exterieur':
            rowIndex = 0;
            break;
        case 'Interieur':
            rowIndex = 1;
            break;
        case 'Insufl.':
            rowIndex = 2;
            break;
        case 'Extract.':
            rowIndex = 3;
            break;
        default:
            // Handle unexpected labels
            return;
    }
    // Mettre à jour la valeur pour la ligne correspondante
    data.setValue(rowIndex, 1, parseFloat(point).toFixed(2));
		// Redessiner le graphique pour refléter les changements
    var chart = new google.visualization.Gauge(document.getElementById('chart_div'));
    chart.draw(data, options);
   }
    </script>
  </head>
  <body>
    <div id="chart_div" style="width: 400px; height: 120px;"></div>
	  
 <div id="chart-container" style="position: relative;">
  <iframe width="450" height="260" style="position: absolute; top: 180; left: 0; border: 0px solid #cccccc;" src="https://thingspeak.com/channels/2344475/charts/1?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=5000&timescale=20&type=line"></iframe>
</div>
<div id="chart-container" style="position: relative;">
  <iframe width="450" height="260" style="position: absolute; top: 180; left: 500; border: 0px solid #cccccc;" src="https://thingspeak.com/channels/2344475/charts/2?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=5000&type=line&update=15"></iframe>
</div>
<div id="chart-container" style="position: relative;">
  <iframe width="450" height="260" style="position: absolute; top: 440; left: 0; border: 0px solid #cccccc;" src="https://thingspeak.com/channels/2344475/charts/3?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=5000&type=line&update=15"></iframe>
</div>
<div id="chart-container" style="position: relative;">
  <iframe width="450" height="260" style="position: absolute; top: 440; left: 500; border: 0px solid #cccccc;" src="https://thingspeak.com/channels/2344475/charts/4?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=5000&type=line&update=15"></iframe>
</div>
	  
<input type="button" class="btn-toggle" value="Démarrer la machine">
  <p class="status-text">0</p>
	  
	  <script>
    var btn = document.querySelector(".btn-toggle");
    var txt = document.querySelector(".status-text");

    btn.addEventListener("click", updateBtn);

    function updateBtn() {
      if (btn.value === "Démarrer la machine") {
        btn.value = "Arrêter la machine";
        txt.textContent = "0";
        // Appelle la fonction pour envoyer la valeur à ThingSpeak
        sendToThingSpeak(0);
      } else {
        btn.value = "Démarrer la machine";
        txt.textContent = "1";
        // Appelle la fonction pour envoyer la valeur à ThingSpeak
        sendToThingSpeak(1);
      }
    }

    // Fonction pour envoyer la valeur à ThingSpeak
    function sendToThingSpeak(fieldValue) {
      var writeAPIKey = 'D2L7PCJKZKXWAK2C'; // Clé d'écriture de l'API ThingSpeak
      var url = 'https://api.thingspeak.com/update.json?api_key=' + writeAPIKey + '&field5=' + fieldValue;
      console.log('URL de la requête:', url); // Affiche l'URL de la requête dans la console
      // Crée une nouvelle requête XMLHttpRequest
      var xhr = new XMLHttpRequest();

      // Configure la requête
      xhr.open('GET', url);

      // Gère la réponse de la requête
      xhr.onload = function() {
        if (xhr.status === 200) {
          console.log('Données envoyées avec succès à ThingSpeak.');
        } else {
          console.error('Erreur lors de l\'envoi des données à ThingSpeak. Statut de la réponse:', xhr.status);
        }
      };

      // Envoie la requête
      xhr.send();
    }

    // Fonction pour exécuter la commande toutes les 5 secondes
    function executeEvery5Seconds() {
      // Définit une fonction qui sera appelée toutes les 5 secondes
      function executeCommand() {
        // Ton code ici
        var btn = document.querySelector(".btn-toggle");
        var txt = document.querySelector(".status-text");

        // Vérifie si le bouton est démarré ou arrêté
        var fieldValue = (btn.value === "Démarrer la machine") ? 1 : 0;

        // Met à jour l'interface utilisateur
        txt.textContent = fieldValue;

        // Appelle la fonction pour envoyer la valeur à ThingSpeak
        sendToThingSpeak(fieldValue);
      }

      // Exécute la fonction immédiatement lors de l'appel de la fonction executeEvery15Seconds
      executeCommand();

      // Planifie l'exécution de la fonction executeCommand toutes les 5 secondes
      setInterval(executeCommand, 5000); // 5 secondes en millisecondes
    }

    // Appelle la fonction pour démarrer l'exécution toutes les 15 secondes
    executeEvery5Seconds();
  </script>
  </body>
</html>
